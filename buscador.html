<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Ubicaci√≥n M√°s Cercana - Bitel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .footer {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
            text-align: center;
        }

        .author-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95em;
            color: #6b7280;
        }

        .author-info a {
            color: #0077b5;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .author-info a:hover {
            color: #005885;
            text-decoration: underline;
        }

        .linkedin-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: fit-content;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        #map {
            height: 600px;
            border-radius: 10px;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .upload-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .location-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .location-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .nearest-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .nearest-card.show {
            display: block;
        }

        .nearest-card .distance {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .directions-btn {
            background: white;
            color: #10b981;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            font-weight: bold;
            color: #374151;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Buscador de Ubicaci√≥n M√°s Cercana</h1>
            <p>Encuentra la ubicaci√≥n de un canal Bitel m√°s cercana a ti</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="upload-section">
                    <h3>üìÅ Cargar Datos</h3>
                    <p style="font-size: 0.9em; margin: 10px 0;">Sube tu archivo CSV</p>
                    <label for="fileInput" class="upload-btn">
                        Seleccionar CSV
                    </label>
                    <input type="file" id="fileInput" accept=".csv">
                    <div id="uploadStatus"></div>
                </div>

                <button id="getLocationBtn" class="location-btn" disabled>
                    üìç Cargar CSV primero
                </button>

                <div id="nearestCard" class="nearest-card">
                    <h3>‚ú® Ubicaci√≥n m√°s cercana</h3>
                    <div class="distance" id="nearestDistance">-</div>
                    <div id="nearestInfo"></div>
                    <button id="directionsBtn" class="directions-btn">
                        üß≠ C√≥mo llegar
                    </button>
                </div>

                <div class="filters">
                    <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                    
                    <div class="filter-group">
                        <label>Distrito</label>
                        <select id="precintoFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group"> 
                        <label>BC</label>
                        <select id="centroCodigoFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Usuario</label>
                        <select id="usuarioFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Canal</label>
                        <select id="canalFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="totalLocations">0</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="filteredCount">0</div>
                        <div class="label">Filtradas</div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <div class="footer">
            <div class="author-info">
                <span>Developed by <strong>Ruri Enciso</strong></span>
                <span>|</span>
                <a href="https://pe.linkedin.com/in/ruri-enciso" target="_blank" rel="noopener noreferrer">
                    <svg class="linkedin-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    LinkedIn
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        console.log('Script iniciado');
        
        let map;
        let markers = [];
        let userMarker = null;
        let allData = [];
        let filteredData = [];
        let userLocation = null;
        let nearestMarker = null;

        // Inicializar mapa
        try {
            map = L.map('map').setView([-12.0464, -77.0428], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            console.log('Mapa inicializado');
        } catch (e) {
            console.error('Error al inicializar mapa:', e);
            alert('Error al cargar el mapa. Verifica tu conexi√≥n a internet.');
        }

        // Calcular distancia (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Cargar CSV
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('Cargando archivo:', file.name);
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status">Cargando...</div>';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('Datos parseados:', results.data.length);
                    
                    // Mostrar nombres de columnas disponibles
                    if (results.data.length > 0) {
                        console.log('=== COLUMNAS DISPONIBLES EN EL CSV ===');
                        console.log(Object.keys(results.data[0]));
                        console.log('=====================================');
                    }
                    
                    allData = results.data.filter(row => row.Longitud && row.Latitud);
                    filteredData = [...allData];
                    
                    console.log('Datos v√°lidos:', allData.length);
                    
                    populateFilters();
                    updateStats();
                    displayMarkers();
                    
                    document.getElementById('getLocationBtn').disabled = false;
                    document.getElementById('getLocationBtn').textContent = 'üìç Obtener mi ubicaci√≥n';
                    
                    statusDiv.innerHTML = `<div class="status success">‚úì ${allData.length} ubicaciones cargadas</div>`;
                },
                error: function(error) {
                    console.error('Error parsing:', error);
                    statusDiv.innerHTML = `<div class="status error">‚úó Error al cargar</div>`;
                }
            });
        });

        function populateFilters() {
            const precintos = [...new Set(allData.map(d => d.Precinto).filter(Boolean))].sort();
            const centrosCodigo = [...new Set(allData.map(d => d['Centro de Codigo']).filter(Boolean))].sort();
            const usuarios = [...new Set(allData.map(d => d['Usuario']).filter(Boolean))].sort();
            const canales = [...new Set(allData.map(d => d['Tipo de canal']).filter(Boolean))].sort();

            const precintoSelect = document.getElementById('precintoFilter');
            const centroCodigoSelect = document.getElementById('centroCodigoFilter');
            const usuarioSelect = document.getElementById('usuarioFilter');
            const canalSelect = document.getElementById('canalFilter');

            precintoSelect.innerHTML = '<option value="">Todos</option>';
            precintos.forEach(precinto => {
                const option = document.createElement('option');
                option.value = precinto;
                option.textContent = precinto;
                precintoSelect.appendChild(option);
            });

            centroCodigoSelect.innerHTML = '<option value="">Todos</option>';
            centrosCodigo.forEach(centro => {
                const option = document.createElement('option');
                option.value = centro;
                option.textContent = centro;
                centroCodigoSelect.appendChild(option);
            });

            usuarioSelect.innerHTML = '<option value="">Todos</option>';
            usuarios.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario;
                option.textContent = usuario;
                usuarioSelect.appendChild(option);
            });

            canalSelect.innerHTML = '<option value="">Todos</option>';
            canales.forEach(canal => {
                const option = document.createElement('option');
                option.value = canal;
                option.textContent = canal;
                canalSelect.appendChild(option);
            });
        }

        document.getElementById('precintoFilter').addEventListener('change', applyFilters);
        document.getElementById('centroCodigoFilter').addEventListener('change', applyFilters);
        document.getElementById('usuarioFilter').addEventListener('change', applyFilters);
        document.getElementById('canalFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const precinto = document.getElementById('precintoFilter').value;
            const centroCodigo = document.getElementById('centroCodigoFilter').value;
            const usuario = document.getElementById('usuarioFilter').value;
            const canal = document.getElementById('canalFilter').value;

            filteredData = allData.filter(row => {
                if (precinto && row.Precinto !== precinto) return false;
                if (centroCodigo && row['Centro de Codigo'] !== centroCodigo) return false;
                if (usuario && row['Usuario'] !== usuario) return false;
                if (canal && row['Tipo de canal'] !== canal) return false;
                return true;
            });

            displayMarkers();
            updateStats();
            
            if (userLocation) {
                findNearest();
            }
        }

        function displayMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const bounds = [];

            filteredData.forEach(row => {
                const lat = parseFloat(row.Latitud);
                const lon = parseFloat(row.Longitud);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: "#ef4444",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${row.Precinto || 'N/A'}</b><br>
                        Centro de C√≥digo: ${row['Centro de Codigo'] || 'N/A'}<br>
                        <!-- Departamento: ${row.Provincia || 'N/A'}<br> -->
                        C√≥digo de canal: ${row['Codigo de canal'] || 'N/A'}<br>
                        Usuario: ${row['Usuario'] || 'N/A'}<br>
                        Canal: ${row['Tipo de canal'] || 'N/A'}
                        <br>Celular: ${row['Numero telefonico'] || 'N/A'}   
                    `);
                    
                    marker.data = row;
                    markers.push(marker);
                    bounds.push([lat, lon]);
                }
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        document.getElementById('getLocationBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üìç Obteniendo ubicaci√≥n...';

            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalizaci√≥n');
                btn.disabled = false;
                btn.textContent = 'üìç Obtener mi ubicaci√≥n';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    console.log('Ubicaci√≥n obtenida:', userLocation);

                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    userMarker = L.circleMarker([userLocation.lat, userLocation.lng], {
                        radius: 10,
                        fillColor: "#3b82f6",
                        color: "#fff",
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map);
                    
                    userMarker.bindPopup('<b>üìç Tu ubicaci√≥n</b>').openPopup();

                    map.setView([userLocation.lat, userLocation.lng], 12);

                    findNearest();

                    btn.disabled = false;
                    btn.textContent = 'üîÑ Actualizar ubicaci√≥n';
                },
                function(error) {
                    console.error('Error geolocalizaci√≥n:', error);
                    alert('No se pudo obtener tu ubicaci√≥n. Verifica los permisos.');
                    btn.disabled = false;
                    btn.textContent = 'üìç Obtener mi ubicaci√≥n';
                }
            );
        });

        function findNearest() {
            if (!userLocation || filteredData.length === 0) return;

            let nearest = null;
            let minDistance = Infinity;

            filteredData.forEach(row => {
                const lat = parseFloat(row.Latitud);
                const lon = parseFloat(row.Longitud);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const distance = calculateDistance(
                        userLocation.lat, 
                        userLocation.lng, 
                        lat, 
                        lon
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...row, lat, lon, distance };
                    }
                }
            });

            if (nearest) {
                showNearest(nearest);
            }
        }

        function showNearest(location) {
            const card = document.getElementById('nearestCard');
            const distance = document.getElementById('nearestDistance');
            const info = document.getElementById('nearestInfo');

            distance.textContent = `${location.distance.toFixed(2)} km`;
            info.innerHTML = `
                <div><strong>üìç ${location.Precinto || 'N/A'}</strong></div>
                <div>BC: ${location['Centro de Codigo'] || 'N/A'}</div>
                <!-- <div>Departamento: ${location.Provincia || 'N/A'}</div> -->
                <div>C√≥digo: ${location['Codigo de canal'] || 'N/A'}</div>
                <div>Usuario: ${location['Usuario'] || 'N/A'}</div>
                <div>Canal: ${location['Tipo de canal'] || 'N/A'}</div>
                <div>Cel: ${location['Numero telefonico'] || 'N/A'}</div>
            `;

            card.classList.add('show');

            if (nearestMarker) {
                nearestMarker.setStyle({
                    radius: 6,
                    fillColor: "#ef4444"
                });
            }

            markers.forEach(marker => {
                if (marker.data.Longitud === location.Longitud && marker.data.Latitud === location.Latitud) {
                    marker.setStyle({
                        radius: 12,
                        fillColor: "#10b981"
                    });
                    nearestMarker = marker;
                    marker.openPopup();
                }
            });

            document.getElementById('directionsBtn').onclick = function() {
                const url = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${location.lat},${location.lon}`;
                window.open(url, '_blank');
            };
        }

        function updateStats() {
            document.getElementById('totalLocations').textContent = allData.length;
            document.getElementById('filteredCount').textContent = filteredData.length;
        }

        console.log('Todo cargado correctamente');
    </script>
</body>
</html>