<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Ubicaci√≥n M√°s Cercana - Bitel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: fit-content;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        #map {
            height: 600px;
            border-radius: 10px;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .upload-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .location-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .location-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .nearest-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .nearest-card.show {
            display: block;
        }

        .nearest-card .distance {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .directions-btn {
            background: white;
            color: #10b981;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            font-weight: bold;
            color: #374151;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Buscador de Ubicaci√≥n M√°s Cercana</h1>
            <p>Encuentra la ubicaci√≥n Bitel/BC m√°s cercana a ti</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="upload-section">
                    <h3>üìÅ Cargar Datos</h3>
                    <p style="font-size: 0.9em; margin: 10px 0;">Sube tu archivo CSV</p>
                    <label for="fileInput" class="upload-btn">
                        Seleccionar CSV
                    </label>
                    <input type="file" id="fileInput" accept=".csv">
                    <div id="uploadStatus"></div>
                </div>

                <button id="getLocationBtn" class="location-btn" disabled>
                    üìç Cargar CSV primero
                </button>

                <div id="nearestCard" class="nearest-card">
                    <h3>‚ú® Ubicaci√≥n m√°s cercana</h3>
                    <div class="distance" id="nearestDistance">-</div>
                    <div id="nearestInfo"></div>
                    <button id="directionsBtn" class="directions-btn">
                        üß≠ C√≥mo llegar
                    </button>
                </div>

                <div class="filters">
                    <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                    
                    <div class="filter-group">
                        <label>Distrito</label>
                        <select id="distritoFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>BC</label>
                        <select id="bcFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="totalLocations">0</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="filteredCount">0</div>
                        <div class="label">Filtradas</div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        console.log('Script iniciado');
        
        let map;
        let markers = [];
        let userMarker = null;
        let allData = [];
        let filteredData = [];
        let userLocation = null;
        let nearestMarker = null;

        // Inicializar mapa
        try {
            map = L.map('map').setView([-12.0464, -77.0428], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            console.log('Mapa inicializado');
        } catch (e) {
            console.error('Error al inicializar mapa:', e);
            alert('Error al cargar el mapa. Verifica tu conexi√≥n a internet.');
        }

        // Calcular distancia (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Cargar CSV
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('Cargando archivo:', file.name);
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status">Cargando...</div>';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('Datos parseados:', results.data.length);
                    allData = results.data.filter(row => row.X && row.Y);
                    filteredData = [...allData];
                    
                    console.log('Datos v√°lidos:', allData.length);
                    
                    populateFilters();
                    updateStats();
                    displayMarkers();
                    
                    document.getElementById('getLocationBtn').disabled = false;
                    document.getElementById('getLocationBtn').textContent = 'üìç Obtener mi ubicaci√≥n';
                    
                    statusDiv.innerHTML = `<div class="status success">‚úì ${allData.length} ubicaciones cargadas</div>`;
                },
                error: function(error) {
                    console.error('Error parsing:', error);
                    statusDiv.innerHTML = `<div class="status error">‚úó Error al cargar</div>`;
                }
            });
        });

        function populateFilters() {
            const distritos = [...new Set(allData.map(d => d.DISTRITO).filter(Boolean))].sort();
            const bcs = [...new Set(allData.map(d => d.BC).filter(Boolean))].sort();

            const distritoSelect = document.getElementById('distritoFilter');
            const bcSelect = document.getElementById('bcFilter');

            distritoSelect.innerHTML = '<option value="">Todos</option>';
            distritos.forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito;
                option.textContent = distrito;
                distritoSelect.appendChild(option);
            });

            bcSelect.innerHTML = '<option value="">Todos</option>';
            bcs.forEach(bc => {
                const option = document.createElement('option');
                option.value = bc;
                option.textContent = bc;
                bcSelect.appendChild(option);
            });
        }

        document.getElementById('distritoFilter').addEventListener('change', applyFilters);
        document.getElementById('bcFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const distrito = document.getElementById('distritoFilter').value;
            const bc = document.getElementById('bcFilter').value;

            filteredData = allData.filter(row => {
                if (distrito && row.DISTRITO !== distrito) return false;
                if (bc && row.BC !== bc) return false;
                return true;
            });

            displayMarkers();
            updateStats();
            
            if (userLocation) {
                findNearest();
            }
        }

        function displayMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const bounds = [];

            filteredData.forEach(row => {
                const lat = parseFloat(row.Y);
                const lon = parseFloat(row.X);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: "#ef4444",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${row.DISTRITO || 'N/A'}</b><br>
                        BC: ${row.BC || 'N/A'}<br>
                        Provincia: ${row.PROVINCIA || 'N/A'}
                    `);
                    
                    marker.data = row;
                    markers.push(marker);
                    bounds.push([lat, lon]);
                }
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        document.getElementById('getLocationBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üìç Obteniendo ubicaci√≥n...';

            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalizaci√≥n');
                btn.disabled = false;
                btn.textContent = 'üìç Obtener mi ubicaci√≥n';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    console.log('Ubicaci√≥n obtenida:', userLocation);

                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    userMarker = L.circleMarker([userLocation.lat, userLocation.lng], {
                        radius: 10,
                        fillColor: "#3b82f6",
                        color: "#fff",
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map);
                    
                    userMarker.bindPopup('<b>üìç Tu ubicaci√≥n</b>').openPopup();

                    map.setView([userLocation.lat, userLocation.lng], 12);

                    findNearest();

                    btn.disabled = false;
                    btn.textContent = 'üîÑ Actualizar ubicaci√≥n';
                },
                function(error) {
                    console.error('Error geolocalizaci√≥n:', error);
                    alert('No se pudo obtener tu ubicaci√≥n. Verifica los permisos.');
                    btn.disabled = false;
                    btn.textContent = 'üìç Obtener mi ubicaci√≥n';
                }
            );
        });

        function findNearest() {
            if (!userLocation || filteredData.length === 0) return;

            let nearest = null;
            let minDistance = Infinity;

            filteredData.forEach(row => {
                const lat = parseFloat(row.Y);
                const lon = parseFloat(row.X);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const distance = calculateDistance(
                        userLocation.lat, 
                        userLocation.lng, 
                        lat, 
                        lon
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...row, lat, lon, distance };
                    }
                }
            });

            if (nearest) {
                showNearest(nearest);
            }
        }

        function showNearest(location) {
            const card = document.getElementById('nearestCard');
            const distance = document.getElementById('nearestDistance');
            const info = document.getElementById('nearestInfo');

            distance.textContent = `${location.distance.toFixed(2)} km`;
            info.innerHTML = `
                <div><strong>üìç ${location.DISTRITO || 'N/A'}</strong></div>
                <div>BC: ${location.BC || 'N/A'}</div>
                <div>Provincia: ${location.PROVINCIA || 'N/A'}</div>
            `;

            card.classList.add('show');

            if (nearestMarker) {
                nearestMarker.setStyle({
                    radius: 6,
                    fillColor: "#ef4444"
                });
            }

            markers.forEach(marker => {
                if (marker.data.X === location.X && marker.data.Y === location.Y) {
                    marker.setStyle({
                        radius: 12,
                        fillColor: "#10b981"
                    });
                    nearestMarker = marker;
                    marker.openPopup();
                }
            });

            document.getElementById('directionsBtn').onclick = function() {
                const url = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${location.lat},${location.lon}`;
                window.open(url, '_blank');
            };
        }

        function updateStats() {
            document.getElementById('totalLocations').textContent = allData.length;
            document.getElementById('filteredCount').textContent = filteredData.length;
        }

        console.log('Todo cargado correctamente');
    </script>
</body>
</html>